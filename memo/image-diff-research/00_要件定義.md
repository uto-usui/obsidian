# 画像差分比較の要件定義

## 1. 背景と目的

Visual Regression Testing (VRT) のプロセスにおいて、UIの意図しない変更（デグレード）を自動的に検出することが目的。この中核となるのが、基準となる画像（ベース画像）とテスト対象の画像（ターゲット画像）を比較し、差異を検出する機能である。

この文書では、その画像比較機能に求められる詳細な要件を定義する。

## 2. 機能要件

### 2.1. コア機能

- **差分検出:** 2つの画像（同じサイズ）を入力とし、ピクセル単位で色の違いを検出できること。
- **差分数値化:** 検出した差異の程度を定量的な数値として出力できること。
    - 差分ピクセル数
    - 全ピクセル数に対する差分率 (%)
- **差分画像生成:** 差異が検出された箇所を、指定した色でハイライトした新しい画像（差分画像）を生成できること。

### 2.2. 精度と柔軟性に関する要件

- **閾値設定:** ある程度の色合いの違いを許容するための閾値（threshold）を設定できること。これにより、圧縮アーティファクトや僅かなレンダリングの違いによる偽陽性を減らす。
- **アンチエイリアシングの考慮:** テキストや図形の境界に発生するアンチエイリアシングによる微細な色の変化を、差分として検出するか、無視するかを選択できるオプションがあること。
- **無視領域（Ignore Regions）の指定:** 画像内の一部領域を比較対象から除外する機能を設けること。動的なコンテンツ（広告、タイムスタンプ、アバターなど）が含まれるエリアの指定を想定する。
- **対象領域（Include Regions）の指定:** 画像内の一部領域のみを比較対象とする機能を設けること。

## 3. 非機能要件

- **パフォーマンス:** 比較処理は高速であること。一般的なウェブページのスクリーンショット（例: 1920x1080px）を1秒以内に処理完了することが望ましい。
- **環境:**
    - **Node.js:** 最新のLTSバージョンで動作すること。
    - **ブラウザ:** 主要なモダンブラウザ（Chrome, Firefox, Safari）の最新バージョンで動作すること。
- **依存性:** 可能な限り、外部の重いライブラリ（特にネイティブバイナリを必要とするもの）への依存が少ないこと。ブラウザ環境では、ネイティブAPI（Canvasなど）を最大限活用することが望ましい。

## 4. 差分画像の仕様

- **フォーマット:** PNG形式で出力できること。
- **ハイライト色:** 差分をハイライトする色は、RGBA値で自由に指定できること。
- **透明度:** 差分がないピクセルは、元の画像（ベース画像）と同じにするか、あるいは透明にするかを選択できると良い。
